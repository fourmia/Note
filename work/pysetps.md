<!--
 * @Author: LiZedong <15516926476@163.com>
 * @Date: 2022-02-10 15:07:11
 * @LastEditors: LiZedong <15516926476@163.com>
 * @LastEditTime: 2022-02-16 10:21:42
 * @FilePath: \A个人笔记\work\pysetps.md
-->
## 1. 简介
`pysteps`是一个开源的、社区驱动的`Python`库，用于概率降水临近预测(0~6h)。

+ 实现了光流法
+ 实现了先进的随机生成器
+ 包含了可视化、后期处理的工具

### 降水临近预报原理

#### Lagrangian persistence
基于外推的降水临近预报假设在几小时的时间框架内，可以通过沿静止运动场移动雷达回波而不改变强度来捕获降水的演变。即从一系列天气雷达图像中跟踪降水特征的运动，然后根据该运动将降水场转移到即将到来的未来（几分钟到几小时），而特征的强度保持不变。

在`pysteps`中实现了三种运动场估计方法:
1. 局部LK方法
2. 全局变分回声跟踪方法
3. 光谱方法

实现的平流方法为： backward-in-time semi-Lagrangian scheme

误差来源
+ 初始状态误差：大气状态不可被精确的观察，导致了降水和运动场当前状态估计的误差
+ 拉格朗日方法中模型误差
  + 违反稳态假设的过程：降水在初始、增长、衰减和终止过程方面的演化
  + 运动场的平稳性假设 **(重点考虑))**：实施过程中产生的不准确性。

<font color=red>问题</font>
    间歇降水率统计量非高斯，边界为0,一个常见的**解决方案**:引入合适的数据转换来近似一个正态分布。

#### a cascade of spatial scales
+ 动态缩放：降水的寿命与其空间尺度相关
+ 关键思想：将降水场分解为一个乘法级联， 级联水平代表不同的空间尺度，并在临近预报模型中分别处理他们
+ 在`STEPS`中，尺度分解是通过对输入降水场应用快速傅里叶变换来完成的。

#### 时间演化
在临近预报中，典型的降水场时间演化模型采用自回归(AR)过程，其结合了**拉格朗日持久性的确定性分量**和**随机扰动**，时间上的自回归模型和空间上的级联模型相结合，可以控制降水的时间演化及相关结构

***

## 2. 任务目标
> 能够熟练使用pysteps，将其作为基准模型

### 具体工作
+ 了解其内置的各种计算方式及其实现
+ 了解数据输入形式，能使用自己的数据来更换原有数据集

***
## 3. 工作开展
- [x] 简要了解`pysteps`提供的`API`
  + `pysteps.cascade` 构建带通滤波器并将二维降水场分解为不同空间尺度的方法
  + `pysteps.decorators` 定义可重复使用的装饰器，包括**降水数据的后处理**、**光流方法的输入**、**所有输入尺寸**、**缓存添加**
  + `pysteps.extrapolation` 外推模块的功能及接口
  + `pysteps.datasets` 用于下载数据并创建指向该位置的配置文件
  + `pysteps.downscaling` 确定性及集成降尺度方法实现
  + `pysteps.feature` 特征检测方法实现
  + `pysteps.io` 浏览数据文档、读取二维降水场和预报写入文件方法实现
  + `pysteps.motion` 光流方法实现
  + `pysteps.noise` 确定性和集合临近预报方法的实施
  + `pysteps.nowcasts` 确定性和集合临近预报方法的实施
  + `pysteps.postprocessing` 预报后处理方法
  + `pysteps.timeseries` 时间序列分析的方法和模型。
  + `pysteps.tracking` 特征跟踪方法
  + `pysteps.utils` 实现辅助功能方法
  + `pysteps.verification` 确定性预报、概率预报和集合预报方法
  + `pysteps.visualization` 绘制降水及预报场的方法
- [x] 安装`pysteps`并测试其提供的样例
  + 各深度学习模型所对应`pysteps`中的基准模型请参考[此网址](https://pysteps.readthedocs.io/en/latest/user_guide/machine_learning_pysteps.html)
- [ ] 在使用方法中了解其技术细节
- [ ] 能够完成各类数据集的替换操作
  - [ ] 进一步了解`pysteps.io`对数据加载的实现
  - [ ] 了解输入数据的形式，并进一步了解`config`文件中日期目录的处理
  - [ ] 各类数据格式及相应时间分辨率
- [ ] 进行深一层封装，使其能轻易的用于模型基准测试

## 4. 参考论文
+ Precipitation Nowcasting with Orographic Enhanced
Stacked Generalization: Improving Deep Learning
Predictions on Extreme Events    <!--基于此篇文章进行参考实现-->
  + **研究背景**: 相较传统模型，深度学习临近预报模型能提供更好的整体预报（小降水情况较好），但整体过度平滑（极端降水预测不佳）
  + **主要目的**：改进深度学习模型对于临近预报中极端降水预测效果不佳的情况，从而达到在小降水条件下达到优于拉格朗日持久化模型的效果，在极端降水条件下达到优于或者持平拉格朗日持久化模型的效果
  + **输入数据**：**恒定高度的反射率图像序列(即PPI/CAPPI/CMAX图像序列)**
  + **观点**:
    + 临近预报的挑战主要来源于不确定性的逐渐累积
    + `MSE`和`MAE`的内在平均效应导致的条件偏差，导致低估高降水情况
    + 目前关于损失函数的知识表明，仅此方法不能用于改善对极端事件的预测（提出了地形与模型集合相结合的观点）
    + 模型平均会加剧条件偏差(**即导致极端降雨率衰减**)，因此采用模型堆叠
    + 

  + **论文结构**
    + 数据集：
      + **TAASRAD19雷达数据集**(Italy)、MAX(Z)产品、C-Band、5-min
      + 分辨率$500M$、matrix$480×480$、时间: 2010/06 ~ 2019/11
      + 最大反射率因子:$52.5dBZ$、使用的Z-R关系:$Z=200R^{1.6}$、转化为降雨率为70mm/h
      + 块结构：最小块包含25帧（2h），最大块包含288帧（1day）
      + 数据集划分：训练及验证**201006~201612**， 测试**201701~201907**
    + 用于创建集成模型的深度学习临近预报模型：
      + 轨迹门控循环单元 (TrajGRU)网络
      + 使用5帧作为模型输入，预测接下来的20帧（即采用了最小块结构，内部划分输入及标的数据）
      + 由于伪影和杂散信号的影响，采用了静态掩码(不确定是否为马氏距离计算得到的)
      + 在进行损失函数时，采用MAE和MSE的相同加权组合计算权重，蒙版像素权重值被设为0
      + 说明了`SSIM`损失在此处不可用的原因:像素掩蔽引入了空间不协调性，预测目标非矩形(圆形) 表明损失函数应**应用于单像素级别*
    + 集成生成策略：
      + 单个深度模型构建集成的两种方法：
        + 向模型的初始条件添加随机扰动
        + 在输入空间的不同子集上训练模型
      + **本文采用的方法**：阈值降水集合(`TRE`) ---> 通过修改损失函数的计算来设置特定域值下的像素权重
        + 其无需对输入数据进行任何采样
        + 使用单一模型生成具有显著不同行为的模型
        + 所有集成成员均将高降水的误差最小化作为损失函数目标
      + 除阈值设定不同外，模型采用的参数情况
        + 固定随机种子数
        + batch size 设定为 4
        + 学习率设定为$1e^{-4}$
        + 采用带有学习率衰减的$Adam$优化器
        + 具有模型检查点的$100000$次迭代训练
        + 每$10000$次迭代进行一轮验证
        + 每个阈值选择具有最低验证损失的模型作为集合成员
    + 堆叠泛化模型（ConvSG）：
      + 采用策略：
        + 利用学习器集合的预测在集合预测之上训练模型，来提高整体准确性，在此处主要是**结合集成输出以减少预测中的CB**（即：高值低估和低值高估）
      + 堆叠模型所用数据集
        + **训练数据**：每个集合成员对2017~2019年数据的预测，76151*4组观测序列，每个序列为$20*480*480$
          + 输入尺寸: $4*20*480*480$，引入堆栈策略后，仅采用每个预测的第一帧图像, 因此输入尺寸变为 $4*1*480*480$，添加地形等信息后，最终的输入尺寸为 $7*1*480*480$
            + **堆栈策略**: 集合成员引入了可以通过模型堆叠恢复的系统误差，并且这种校正可以传播到整个序列
        + **测试数据**：从2017~2019年极端事件天数列表中提取的30天样本，序列数为6840，占总数据集9%，对于验证，在（76151-6840）中抽取3%,即2189个序列
      + 进行了3组数据不平衡分布检查：采用雨量值分布(通过动态z-i关系)和反射率值分布（其中不包含0值，以防止零值支配分布）
      + ConvSG: 在输入及输出的所有转换过程中保持输入数据的全分辨率
    + 增强堆叠泛化：
      + 添加地理信息特征：坡度百分比、坡向和海拔高度，并归一化

    + 模型对比：
      + `pysteps`中实现的`S-PROG`模型，采用`S-PROG`模型作为基准模型

  + 实现思路
    + 采用`pysteps`中实现的`S_PROG`作为基准模型与深度学习模型效果作为对比
    + 采用施行健博士提出的`TrajGRU`模型作为对比的深度学习模型，并在此基础上提出地形增强和集成方法（不同阈值结果堆叠）